<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Património Familiar</title>

  <link rel="icon" href="assets/icon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="stylesheet" href="styles.css?v=4">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="app.js?v=4"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img class="brand__icon" src="assets/icon-192.png" alt="PF">
      <div class="brand__txt">
        <div class="brand__title">Património Familiar</div>
        <div class="brand__sub">Net worth · Distribuição · Rendimento passivo</div>
      </div>
    </div>

    <div class="topbar__actions">
      <button class="btnIcon" id="btnFAB" aria-label="Adicionar">+</button>
    </div>
  </header>

  <main class="main">
    <!-- DASHBOARD -->
    <section class="view" id="viewDashboard" data-view="dashboard">
      <div class="hero">
        <div class="hero__kpi">
          <div class="hero__label">Património líquido</div>
          <div class="hero__value" id="kpiNet">—</div>
          <div class="hero__sub" id="kpiAP">Ativos — | Passivos —</div>
        </div>
        <div class="hero__pill">
          <div class="pillRow">
            <div class="pillBox">
              <div class="pillBox__k">Rendimento passivo (anual)</div>
              <div class="pillBox__v" id="kpiPassiveAnnual">—</div>
            </div>
            <div class="pillBox pillBox--alt">
              <div class="pillBox__k">Mensal (estim.)</div>
              <div class="pillBox__v" id="kpiPassiveMonthly">—</div>
            </div>
          </div>
          <div class="pillRow" style="margin-top:10px">
            <button class="chip" id="btnSnapshot">Registar mês</button>
            <button class="chip chip--ghost" id="btnClearHistory">Limpar histórico</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card__head">
            <div>
              <div class="card__title">Resumo rápido</div>
              <div class="card__muted">Top 10 ativos por valor</div>
            </div>
            <button class="link" id="btnSummaryAll">Ver tudo</button>
          </div>
          <div id="summaryList" class="list"></div>
          <div class="row row--center" style="margin-top:10px">
            <button class="chip chip--ghost" id="btnSummaryToggle" style="display:none">Ver o resto</button>
          </div>
        </div>

        <div class="card">
          <div class="card__head">
            <div>
              <div class="card__title">Distribuição</div>
              <div class="card__muted">Por classe (Ativos)</div>
            </div>
            <button class="link" id="btnDistDetail">Detalhe</button>
          </div>
          <div class="chartWrap">
            <canvas id="distChart" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="card__head">
          <div>
            <div class="card__title">Tendência do património</div>
            <div class="card__muted">Histórico (snapshots)</div>
          </div>
          <div class="hintSmall" id="historyHint">Sem histórico.</div>
        </div>
        <div class="chartWrap">
          <canvas id="trendChart" height="240"></canvas>
        </div>
      </div>

      <div class="spacer"></div>
    </section>

    <!-- ASSETS -->
    <section class="view" id="viewAssets" data-view="assets" hidden>
      <div class="seg">
        <button class="seg__btn seg__btn--active" id="segAssets">Ativos</button>
        <button class="seg__btn" id="segLiabs">Passivos</button>
      </div>

      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title" id="assetsTitle">Ativos</div>
            <div class="card__muted" id="assetsSub">Imobiliário, liquidez, ações/ETFs, metais, cripto, fundos, PPR, depósitos…</div>
          </div>
          <button class="chip" id="btnAddHere">Adicionar</button>
        </div>

        <div class="filters">
          <input class="input" id="qSearch" placeholder="Pesquisar (nome ou classe)" autocomplete="off">
          <select class="input" id="qClass">
            <option value="">Todas as classes</option>
          </select>
          <select class="input" id="qSort">
            <option value="value_desc">Valor ↓</option>
            <option value="value_asc">Valor ↑</option>
            <option value="name_asc">Nome A→Z</option>
          </select>
        </div>
      </div>

      <div id="itemsList" class="list"></div>
      <div class="spacer"></div>
    </section>

    <!-- IMPORT -->
    <section class="view" id="viewImport" data-view="import" hidden>
      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Importar (Excel/CSV)</div>
            <div class="card__muted">Lê localmente. Não envia dados.</div>
          </div>
        </div>

        <div class="row row--wrap" style="gap:10px">
          <input id="fileInput" type="file" class="input" accept=".csv,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv">
          <button class="chip" id="btnImportFile" disabled>Importar</button>
          <button class="chip chip--ghost" id="btnTemplateCSV">Template CSV</button>
        </div>
        <div class="note">
          Colunas típicas: <b>tipo</b> (ativo/passivo/movimento), <b>classe</b>, <b>nome</b>, <b>valor</b>, <b>yield_tipo</b>, <b>yield_valor</b>, <b>data</b>.
        </div>
      </div>

      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Backup</div>
            <div class="card__muted">Exporta/importa JSON.</div>
          </div>
        </div>
        <div class="row row--wrap" style="gap:10px">
          <button class="chip" id="btnExportJSON">Exportar JSON</button>
          <input id="jsonInput" type="file" class="input" accept=".json,application/json">
          <button class="chip chip--ghost" id="btnImportJSON" disabled>Importar JSON</button>
        </div>
      </div>

      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Reset</div>
            <div class="card__muted">Apaga dados deste dispositivo.</div>
          </div>
        </div>
        <button class="chip chip--danger" id="btnReset">Reset total</button>
      </div>

      <div class="spacer"></div>
    </section>

    <!-- CASHFLOW -->
    <section class="view" id="viewCashflow" data-view="cashflow" hidden>
      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Fluxo de caixa</div>
            <div class="card__muted">Entradas e saídas por mês.</div>
          </div>
          <button class="chip" id="btnAddTx">Adicionar movimento</button>
        </div>

        <div class="filters" style="grid-template-columns:1fr 1fr">
          <select class="input" id="cfMonth"></select>
          <select class="input" id="cfYear"></select>
        </div>

        <div class="kpiRow" style="margin-top:12px">
          <div class="kpi kpi--in">
            <div class="kpi__k">Entradas</div>
            <div class="kpi__v" id="cfIn">—</div>
          </div>
          <div class="kpi kpi--out">
            <div class="kpi__k">Saídas</div>
            <div class="kpi__v" id="cfOut">—</div>
          </div>
          <div class="kpi kpi--net">
            <div class="kpi__k">Saldo</div>
            <div class="kpi__v" id="cfNet">—</div>
            <div class="kpi__s" id="cfRate">—</div>
          </div>
        </div>
      </div>

      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Movimentos</div>
            <div class="card__muted">Últimos 5 (expande para ver todos).</div>
          </div>
          <button class="link" id="btnTxToggle" style="display:none">Ver todos</button>
        </div>
        <div id="txList" class="list"></div>
      </div>

      <div class="spacer"></div>
    </section>

    <!-- SETTINGS -->
    <section class="view" id="viewSettings" data-view="settings" hidden>
      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Definições</div>
            <div class="card__muted">Preferências básicas.</div>
          </div>
        </div>
        <div class="filters" style="grid-template-columns:1fr">
          <select class="input" id="baseCurrency">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
          </select>
        </div>
      </div>

      <div class="card" id="txCard">
        <div class="card__head">
          <div>
            <div class="card__title">Metodologia</div>
            <div class="card__muted">Como é calculado o rendimento passivo.</div>
          </div>
        </div>
        <ul class="bullets">
          <li><b>Ações/ETFs/Fundos</b>: <i>yield</i> %/ano ou € / ano.</li>
          <li><b>Depósitos/PPR</b>: taxa %/ano sobre o capital.</li>
          <li><b>Imobiliário</b>: renda mensal (a app anualiza).</li>
        </ul>
      </div>

      <div class="spacer"></div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="bottomnav" role="navigation" aria-label="Navegação">
    <button class="navbtn navbtn--active" data-nav="dashboard" id="navDashboard"><span class="navico">▣</span><span class="navlbl">Dashboard</span></button>
    <button class="navbtn" data-nav="assets" id="navAssets"><span class="navico">≡</span><span class="navlbl">Ativos</span></button>
    <button class="navbtn" data-nav="import" id="navImport"><span class="navico">⇅</span><span class="navlbl">Importar</span></button>
    <button class="navbtn" data-nav="cashflow" id="navCashflow"><span class="navico">€</span><span class="navlbl">Balanço</span></button>
    <button class="navbtn" data-nav="settings" id="navSettings"><span class="navico">⚙</span><span class="navlbl">Definições</span></button>
  </div></nav>

  <!-- Action sheet -->
  <div class="sheet" id="sheet" aria-hidden="true">
    <div class="sheet__bg" id="sheetBg"></div>
    <div class="sheet__panel">
      <div class="sheet__head">
        <div class="sheet__title">Adicionar</div>
        <button class="sheet__close" id="sheetClose">×</button>
      </div>
      <button class="sheet__item" id="sheetAddAsset">+ Ativo</button>
      <button class="sheet__item" id="sheetAddLiab">− Passivo</button>
      <button class="sheet__item" id="sheetAddTx">Movimento (entrada/saída)</button>
      <button class="sheet__item" id="sheetSnapshot">Registar mês</button>
    </div>
  </div>

  <!-- Item modal -->
  <div class="modal" id="itemModal" aria-hidden="true">
    <div class="modal__bg" data-close="item"></div>
    <div class="modal__panel">
      <div class="modal__head">
        <div class="modal__title" id="itemModalTitle">Adicionar</div>
        <button class="modal__close" data-close="item">Fechar</button>
      </div>
      <form id="itemForm" class="modal__body">
        <input type="hidden" id="itemId">
        <input type="hidden" id="itemKind">
        <div class="field">
          <label>Classe</label>
          <select class="input" id="itemClass" required></select>
        </div>
        <div class="field">
          <label>Nome</label>
          <input class="input" id="itemName" placeholder="ex: VWCE, Casa, Ouro, Depósito X" required>
        </div>
        <div class="field">
          <label>Valor (moeda base)</label>
          <input class="input" id="itemValue" type="number" step="0.01" placeholder="ex: 12500" required>
          <div class="hint">Para passivos: valor positivo = dívida (subtrai ao património).</div>
        </div>

        <div class="field">
          <label>Rendimento passivo</label>
          <select class="input" id="yieldType">
            <option value="none">Sem rendimento</option>
            <option value="yield_pct">Yield %/ano</option>
            <option value="income_year">€ / ano</option>
            <option value="rent_month">Renda mensal</option>
          </select>
        </div>
        <div class="field">
          <label>Valor do rendimento</label>
          <input class="input" id="yieldValue" type="number" step="0.01" placeholder="ex: 3.2">
          <div class="hint" id="yieldHint">Sem rendimento passivo associado.</div>
        </div>

        <div class="field">
          <label>Notas</label>
          <textarea class="input" id="itemNotes" rows="3" placeholder="opcional"></textarea>
        </div>

        <div class="row row--between" style="margin-top:12px">
          <button class="chip" type="submit">Guardar</button>
          <button class="chip chip--danger" type="button" id="btnDeleteItem" style="display:none">Eliminar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tx modal -->
  <div class="modal" id="txModal" aria-hidden="true">
    <div class="modal__bg" data-close="tx"></div>
    <div class="modal__panel">
      <div class="modal__head">
        <div class="modal__title" id="txModalTitle">Adicionar movimento</div>
        <button class="modal__close" data-close="tx">Fechar</button>
      </div>
      <form id="txForm" class="modal__body">
        <input type="hidden" id="txId">
        <div class="field">
          <label>Tipo</label>
          <select class="input" id="txType" required>
            <option value="in">Entrada</option>
            <option value="out">Saída</option>
          </select>
        </div>
        <div class="field">
          <label>Categoria</label>
          <input class="input" id="txClass" placeholder="ex: Salário Pedro, Alimentação, Escola" required>
        </div>
        <div class="field">
          <label>Valor</label>
          <input class="input" id="txValue" type="number" step="0.01" required>
        </div>
        <div class="field">
          <label>Data</label>
          <input class="input" id="txDate" type="date" required>
        </div>
        <div class="field">
          <label>Notas</label>
          <textarea class="input" id="txNotes" rows="2" placeholder="opcional"></textarea>
        </div>
        <div class="row row--between" style="margin-top:12px">
          <button class="chip" type="submit">Guardar</button>
          <button class="chip chip--danger" type="button" id="btnDeleteTx" style="display:none">Eliminar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Dist modal -->
  <div class="modal" id="distModal" aria-hidden="true">
    <div class="modal__bg" data-close="dist"></div>
    <div class="modal__panel">
      <div class="modal__head">
        <div class="modal__title">Distribuição (Ativos)</div>
        <button class="modal__close" data-close="dist">Fechar</button>
      </div>
      <div class="modal__body">
        <div id="distList" class="list"></div>
        <div class="row row--center" style="margin-top:10px">
          <button class="chip chip--ghost" id="btnDistToggle" style="display:none">Ver o resto</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
